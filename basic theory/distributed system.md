# 简介
## 网络问题
_什么是网络分区问题?_
```
网络出现多个分区, 分区内的节点正常通信, 分区之间无法正常通信

🌙 例如: 跨地域机房之间网络故障, 机房之间机器可以正常通信
```

_网络通信时存在的问题有哪些?_
```
🌟 可能会重排序报文
🌟 可能会重复发送报文
🌟 可能会丢失报文
🌟 可能修改报文

🌙 重排问题可以通过编号解决, 重复发送问题需要通过幂等手段解决, 修改报文问题通过TSL协议解决
🌙 丢失报文问题工程上假设可以通过有限次重试可以解决(假设大部分情况下网络是准时的, TCP实现方案)
```

# 分布式数据库

## 1. 分片

_哈希分片相较于范围分片的优点?_

```
🌟 哈希分片: 各个节点的数据更均匀
🌟 范围分片: 支持范围查询
```

_一致性哈希算法有什么优点?_

```
普通的hash算法将key直接映射为节点(key -> 节点), 一致性哈希函数将key先映射为slot, slot再对应节点, slot数量不变(key -> slot -> 节点)

🌙 优点: 节点增加/减少时, 一致性hash由于slot数量不变只要迁移部分slot(变动节点的slot)的数据, 普通hash算法需要迁移几乎所有节点的数据
```

## 2. 复制

_为什么要复制数据?_
```
提高可用性(A)和分区容错性(P)

🌙 复制会导致数据一致性(C)降低
```

_主从节点之间数据的复制方式分为哪三种?_

```
🌟同步复制: 主节点等待所有从节点写入完成才响应客户端写入成功(数据一致性最高)
🌟异步复制(最常用): 主节点写入完成后直接响应客户端, 稍后再将数据写入到从节点(数据一致性最低)
🌟半同步复制: 主节点等待部分从节点写入完成就可以响应客户端写入成功
```

_主从节点时主/从节点出现故障会发生什么?_
```
🌟 主节点故障: 通过共识算法选举出一个从节点作为新的主节点
🌟 从节点故障: 从节点恢复后重新连接主节点, 进行全量/增量数据同步
```

_什么是脑裂?_
```
主从架构中, 网络分区时从节点认为主节点宕机, 从而产生两个主节点
```

_讲一下Quorum数据冗余机制?_

```
在N个节点的集群中, 假设每次至少写入W个节点, 每次读至少从R个节点读, 那么需要满足:
W + R > N
```


_讲一下分布式系统的一致性强弱等级?_

```
一致性从强到弱分别为:
1️⃣线性一致性(linearizability)
所有客户端的读写操作会被放到同一个FIFO执行队列中像单机一样执行, 并发操作之间顺序可交换

2️⃣顺序一致性(sequential consistency)
每个客户端的读写操作会被放入到各自的FIFO执行队列中像单机一样执行

3️⃣因果一致性(happens-before)
有因果关系的操作需要先后在分布式系统中像单机一样执行, 其他操作可以乱序执行

4️⃣最终一致性(eventual consistency)
可能从分布式系统中部分节点读到旧数据, 但最终读到的数据是最新的
```

## 3. 分布式理论
_如何证明 CAP 理论?_
```
反证: 假设存在CAP三者满足的分布式系统, 由于有分区容错性可以出现网络分区, 当出现网络分区时向一个分区写入X新值, 从另一个分区读X, 必然出现不一致
```

# 分布式一致性协议
_分布式一致性协议有哪些?_
```
🌟 Paxos
🌟 Raft
两个算法实现逻辑不易理解(不知道为什么这么设计), 这里略过

🌙 Raft算法更容易理解, 应用更广
🌙 Raft算法大致思想就是选举出一个Leader节点, 一切以Leader节点为准, 一个epoch只有一个Leader
```

# 分布式事务

_单机数据库如何实现事务的原子性问题?_

```
使用Write Ahead Log(WAL), 在写入磁盘前先写入日志, 例如Innodb执行事务时:

1. 修改buffer pool中的数据页
2. 将修改过程记录到内存中的redo log buffer中
3. 事务要提交时, 将redo log从内存刷新到磁盘, 状态为Commit Record, 此时事务提交成功
4. 定时将buffer pool中的脏数据页刷新到磁盘中, 刷新后将磁盘中的redo log状态标记为End Record

tip: 在数据库crash后的重启阶段, 会先执行redo log中状态为Commit Record的记录, 恢复内存中丢失的数据页
```

_什么是 2PC /3PC 算法, 有什么缺点?_

```
2PC为两阶段提交算法
1. 第一阶段(prepare)
所有participants执行子事务的内容后在提交前告诉coordinator自己能否提交子事务

2. 第二阶段(commit)
coordinator通知所有participants是提交事务还是回滚事务

缺点: 同步阻塞问题, 单点故障问题, 数据不一致问题
---------------------------------
3PC在2PC的两个阶段前新增了一个阶段, 用于询问各个子事务执行者是否准备就绪
```

_什么是 Saga 事务?_

```
将一个分布式事务分为多个子事务T1 T2 T3, 每个子事务有一个补偿事务C1 C2 C3, 当子事务执行失败时按栈的顺序执行已经完成的子事务的补偿事务

示例: 网购场景中, 子事务有: 库存-1, 创建订单, 支付;  对应的补偿事务为库存+1, 删除订单, 退款
```

_讲一下 TCC ?_

```
TCC (Try-Commit-Cancle): 每个服务实现3种接口(try, commit, cancle), try接口预订资源, commit执行子事务, cancle释放预留资源

* 互联网金融业务常常使用TCC
```

# 时间

_哪个网络协议用于同步时间?_

```
NTP协议

协议核心思想: 通过客户端和服务端发送和接收网络包的时间戳计算网络延迟
```

_什么是逻辑时钟?_

```
逻辑时钟是描述分布式系统中因果关系的时间, 有因果关系的两个事件的逻辑时钟必然有序(逻辑时钟有序的两个事件不一定为因果关系)

* 每个进程新发生一个事件时进程的逻辑时钟C+1
* 进程A向进程B通信时如果C(A)+1 > C(B), 则更新C(B)
```

_什么是向量时钟?_

```
每个进程维护一个逻辑时钟向量V[i], V[i, j]为分布式系统中第i个节点维护的j号节点的逻辑时钟, 进程通信时会交互并更新向量

作用: 分布式数据库中用于检测数据冲突
```

# 参考资料
深入理解分布式系统 -唐伟志
